---
name: CI

on:
    push:
        paths-ignore:
            - README.md
            - .editorconfig
            - .pre-commit-config.yaml

    release:
        types:
            - created

env:
    IMAGE_NAME: efsa-io/rbprettier

jobs:
    build:
        runs-on: ubuntu-20.04
        steps:
            - uses: actions/checkout@v2

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to Github Packages
              uses: docker/login-action@v1
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build image
              uses: docker/build-push-action@v2
              with:
                  context: .
                  file: Dockerfile
                  push: false
                  tags: |
                      ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
                  outputs: type=docker,dest=${{ github.ref_name }}.tar

            - name: Upload image as artifact
              uses: actions/upload-artifact@v2
              with:
                  name: ${{ github.ref_name }}
                  path: ${{ github.ref_name }}.tar
                  if-no-files-found: error

    test:
        runs-on: ubuntu-20.04
        needs: [build]
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v2
              with:
                  name: ${{ github.ref_name }}

            - name: Load Docker image from .tar
              run: |
                  docker load --input ${{ github.ref_name }}.tar

            - name: hello.rb
              run: |
                  mkdir tests
                  echo 'puts "Hello world!"' > tests/hello.rb
                  docker run --rm -v $(pwd):/src ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
                  cat tests/hello.rb

            - id: hello
              run: echo "::set-output name=value::$(cat tests/hello.rb)"

            - uses: nick-invision/assert-action@v1
              with:
                  expected: puts 'Hello world!'
                  actual: ${{ steps.hello.outputs.value }}

    publish:
        runs-on: ubuntu-20.04
        if: github.event_name == 'release' && github.ref_type == 'tag'
        needs: [test]
        steps:
            - uses: actions/checkout@v2

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to Github Packages
              uses: docker/login-action@v1
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build image and push to GitHub Container Registry
              uses: docker/build-push-action@v2
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ env.IMAGE_NAME }}:latest
                      ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

            - name: Pull Docker image
              run: |
                  docker pull ghcr.io/${{ env.IMAGE_NAME }}:latest
                  docker pull ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
